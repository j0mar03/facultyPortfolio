#!/usr/bin/env bash
set -euo pipefail

# Ensure app is bootstrapped
if [ ! -f "composer.json" ]; then
  echo "Laravel app not found. Run bin/bootstrap first."
  exit 1
fi

# Copy config for portfolio
docker compose exec -T app bash -lc "mkdir -p config"
docker compose exec -T app bash -lc "cat > config/portfolio.php <<'PHP'\n<?php\nreturn [\n\t'required_items' => [\n\t\t'syllabus','sample_quiz','major_exam','tos','activity_rubrics','grade_sheets','sample_ims','acknowledgement','attendance','class_list','faculty_assignment'\n\t],\n\t'rules' => [\n\t\t'syllabus' => ['mimes:pdf','max:10240'],\n\t\t'grade_sheets' => ['mimes:xlsx,csv,pdf','max:10240'],\n\t],\n];\nPHP"

# Generate migrations for domain schema (if not already present)
docker compose exec -T app bash -lc "php artisan make:migration create_courses_table --create=courses || true"
docker compose exec -T app bash -lc "php artisan make:migration create_subjects_table --create=subjects || true"
docker compose exec -T app bash -lc "php artisan make:migration create_class_offerings_table --create=class_offerings || true"
docker compose exec -T app bash -lc "php artisan make:migration create_portfolios_table --create=portfolios || true"
docker compose exec -T app bash -lc "php artisan make:migration create_portfolio_items_table --create=portfolio_items || true"
docker compose exec -T app bash -lc "php artisan make:migration create_reviews_table --create=reviews || true"
docker compose exec -T app bash -lc "php artisan make:migration create_audit_logs_table --create=audit_logs || true"
docker compose exec -T app bash -lc "php artisan make:migration create_imports_table --create=imports || true"

# Write migration contents
docker compose exec -T app bash -lc "ls database/migrations/*create_courses_table*.php | xargs -I{} bash -lc 'cat > {} <<\"PHP\" \n<?php\nuse Illuminate\\Database\\Migrations\\Migration;\nuse Illuminate\\Database\\Schema\\Blueprint;\nuse Illuminate\\Support\\Facades\\Schema;\nreturn new class extends Migration {\n\tpublic function up(): void { Schema::create(\"courses\", function (Blueprint $table) { $table->id(); $table->string(\"code\")->unique(); $table->string(\"name\"); $table->timestamps(); }); }\n\tpublic function down(): void { Schema::dropIfExists(\"courses\"); }\n};\nPHP'"
docker compose exec -T app bash -lc "ls database/migrations/*create_subjects_table*.php | xargs -I{} bash -lc 'cat > {} <<\"PHP\" \n<?php\nuse Illuminate\\Database\\Migrations\\Migration;\nuse Illuminate\\Database\\Schema\\Blueprint;\nuse Illuminate\\Support\\Facades\\Schema;\nreturn new class extends Migration {\n\tpublic function up(): void { Schema::create(\"subjects\", function (Blueprint $table) { $table->id(); $table->foreignId(\"course_id\")->constrained()->cascadeOnDelete(); $table->string(\"code\"); $table->string(\"title\"); $table->unsignedTinyInteger(\"year_level\"); $table->unsignedTinyInteger(\"term\"); $table->unique([\"course_id\",\"code\",\"year_level\",\"term\"], \"subjects_unique\"); $table->timestamps(); }); }\n\tpublic function down(): void { Schema::dropIfExists(\"subjects\"); }\n};\nPHP'"
docker compose exec -T app bash -lc "ls database/migrations/*create_class_offerings_table*.php | xargs -I{} bash -lc 'cat > {} <<\"PHP\" \n<?php\nuse Illuminate\\Database\\Migrations\\Migration;\nuse Illuminate\\Database\\Schema\\Blueprint;\nuse Illuminate\\Support\\Facades\\Schema;\nreturn new class extends Migration {\n\tpublic function up(): void { Schema::create(\"class_offerings\", function (Blueprint $table) { $table->id(); $table->foreignId(\"subject_id\")->constrained()->cascadeOnDelete(); $table->string(\"academic_year\"); $table->unsignedTinyInteger(\"term\"); $table->string(\"section\"); $table->foreignId(\"faculty_id\")->nullable()->constrained(\"users\")->nullOnDelete(); $table->unique([\"subject_id\",\"academic_year\",\"term\",\"section\"], \"class_offering_unique\"); $table->timestamps(); }); }\n\tpublic function down(): void { Schema::dropIfExists(\"class_offerings\"); }\n};\nPHP'"
docker compose exec -T app bash -lc "ls database/migrations/*create_portfolios_table*.php | xargs -I{} bash -lc 'cat > {} <<\"PHP\" \n<?php\nuse Illuminate\\Database\\Migrations\\Migration;\nuse Illuminate\\Database\\Schema\\Blueprint;\nuse Illuminate\\Support\\Facades\\Schema;\nreturn new class extends Migration {\n\tpublic function up(): void { Schema::create(\"portfolios\", function (Blueprint $table) { $table->id(); $table->foreignId(\"user_id\")->constrained()->cascadeOnDelete(); $table->foreignId(\"class_offering_id\")->constrained()->cascadeOnDelete(); $table->enum(\"status\", [\"draft\",\"submitted\",\"approved\",\"rejected\"])->default(\"draft\"); $table->unsignedInteger(\"resubmission_count\")->default(0); $table->timestamp(\"submitted_at\")->nullable(); $table->timestamp(\"approved_at\")->nullable(); $table->timestamps(); $table->unique([\"user_id\",\"class_offering_id\"], \"portfolio_unique\"); }); }\n\tpublic function down(): void { Schema::dropIfExists(\"portfolios\"); }\n};\nPHP'"
docker compose exec -T app bash -lc "ls database/migrations/*create_portfolio_items_table*.php | xargs -I{} bash -lc 'cat > {} <<\"PHP\" \n<?php\nuse Illuminate\\Database\\Migrations\\Migration;\nuse Illuminate\\Database\\Schema\\Blueprint;\nuse Illuminate\\Support\\Facades\\Schema;\nreturn new class extends Migration {\n\tpublic function up(): void { Schema::create(\"portfolio_items\", function (Blueprint $table) { $table->id(); $table->foreignId(\"portfolio_id\")->constrained()->cascadeOnDelete(); $table->string(\"type\"); $table->string(\"title\")->nullable(); $table->string(\"file_path\"); $table->json(\"metadata_json\")->nullable(); $table->timestamps(); $table->index([\"portfolio_id\",\"type\"]); }); }\n\tpublic function down(): void { Schema::dropIfExists(\"portfolio_items\"); }\n};\nPHP'"
docker compose exec -T app bash -lc "ls database/migrations/*create_reviews_table*.php | xargs -I{} bash -lc 'cat > {} <<\"PHP\" \n<?php\nuse Illuminate\\Database\\Migrations\\Migration;\nuse Illuminate\\Database\\Schema\\Blueprint;\nuse Illuminate\\Support\\Facades\\Schema;\nreturn new class extends Migration {\n\tpublic function up(): void { Schema::create(\"reviews\", function (Blueprint $table) { $table->id(); $table->foreignId(\"portfolio_id\")->constrained()->cascadeOnDelete(); $table->foreignId(\"reviewer_id\")->constrained(\"users\")->cascadeOnDelete(); $table->enum(\"decision\", [\"approved\",\"rejected\",\"changes_requested\"]); $table->text(\"remarks\")->nullable(); $table->timestamps(); }); }\n\tpublic function down(): void { Schema::dropIfExists(\"reviews\"); }\n};\nPHP'"
docker compose exec -T app bash -lc "ls database/migrations/*create_audit_logs_table*.php | xargs -I{} bash -lc 'cat > {} <<\"PHP\" \n<?php\nuse Illuminate\\Database\\Migrations\\Migration;\nuse Illuminate\\Database\\Schema\\Blueprint;\nuse Illuminate\\Support\\Facades\\Schema;\nreturn new class extends Migration {\n\tpublic function up(): void { Schema::create(\"audit_logs\", function (Blueprint $table) { $table->id(); $table->foreignId(\"user_id\")->nullable()->constrained()->nullOnDelete(); $table->string(\"action\"); $table->string(\"entity_type\"); $table->unsignedBigInteger(\"entity_id\"); $table->json(\"meta_json\")->nullable(); $table->timestamps(); $table->index([\"entity_type\",\"entity_id\"]); }); }\n\tpublic function down(): void { Schema::dropIfExists(\"audit_logs\"); }\n};\nPHP'"
docker compose exec -T app bash -lc "ls database/migrations/*create_imports_table*.php | xargs -I{} bash -lc 'cat > {} <<\"PHP\" \n<?php\nuse Illuminate\\Database\\Migrations\\Migration;\nuse Illuminate\\Database\\Schema\\Blueprint;\nuse Illuminate\\Support\\Facades\\Schema;\nreturn new class extends Migration {\n\tpublic function up(): void { Schema::create(\"imports\", function (Blueprint $table) { $table->id(); $table->string(\"type\"); $table->enum(\"status\", [\"pending\",\"processing\",\"completed\",\"failed\"])->default(\"pending\"); $table->json(\"stats_json\")->nullable(); $table->string(\"file_path\"); $table->timestamps(); }); }\n\tpublic function down(): void { Schema::dropIfExists(\"imports\"); }\n};\nPHP'"

# Seeders
docker compose exec -T app bash -lc "php artisan make:seeder CourseSeeder || true"
docker compose exec -T app bash -lc "cat > database/seeders/CourseSeeder.php <<'PHP'\n<?php\nnamespace Database\\Seeders;\nuse Illuminate\\Database\\Seeder;\nuse Illuminate\\Support\\Facades\\DB;\nclass CourseSeeder extends Seeder { public function run(): void { $courses = [\n\t['code' => 'DCvET','name' => 'Diploma in Civil Engineering Technology'],\n\t['code' => 'DCET','name' => 'Diploma in Computer Engineering Technology'],\n\t['code' => 'DEET','name' => 'Diploma in Electrical Engineering Technology'],\n\t['code' => 'DECET','name' => 'Diploma in Electronics and Communications Eng. Tech.'],\n\t['code' => 'DICT','name' => 'Diploma in Information and Communication Technology'],\n\t['code' => 'DMET','name' => 'Diploma in Mechanical Engineering Technology'],\n\t['code' => 'DOMT','name' => 'Diploma in Office Management Technology'],\n\t['code' => 'DRET','name' => 'Diploma in Railway Engineering Technology'],\n]; foreach ($courses as $c) { DB::table('courses')->updateOrInsert(['code'=>$c['code']], ['name'=>$c['name']]); } } }\nPHP"

docker compose exec -T app bash -lc "php artisan db:seed --class=CourseSeeder"

# Run migrations
docker compose exec -T app bash -lc "php artisan migrate --force"

echo 'Domain schema and seeders applied.'


